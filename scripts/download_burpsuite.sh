#!/bin/bash

# get the current timestamp to use for a unique log filename
timestamp=$(date +"%Y%m%d_%H%M%S")
log_file="/var/log/pkfod-build/burpsuite-logs/download_burpsuite_$timestamp.log"

# function to check error code
# if error code == 0, then append a success message to the log file
# if error code != 0, then append an error message to the log file
check_error_code() {
    command_status=$1
    command_name=$2
    if [ $command_status -eq 0 ]; then
        echo "Command '$command_name' was executed successfully."
        echo "Command '$command_name' was executed successfully." >> "$log_file"
    else
        echo "Command '$command_name' failed with error code $command_status."
        echo "Command '$command_name' failed with error code $command_status." >> "$log_file"
    fi
}

echo -e "\nRunning sudo apt update..." | tee -a "$log_file"
sudo apt update
status=$?
check_error_code $status "sudo apt update"

echo -e "\nRunning sudo apt upgrade..." | tee -a "$log_file"
sudo apt upgrade -y
status=$?
check_error_code $status "sudo apt upgrade"

# install wget if you don't have it
echo -e "\nInstalling wget..." | tee -a "$log_file"
sudo apt install wget
status=$?
check_error_code $status "sudo apt install wget"

# define the download URL for burpsuite pro
URL="https://portswigger-cdn.net/burp/releases/download?product=pro&version=2023.6.2&type=Linux"

echo -e "\nCreating directory to store the download..." | tee -a "$log_file"
burpsuite_directory="/home/Kali/tools/burpsuite-pro"

if [ ! -d "$burpsuite_directory" ]; then
    # create the directory
    sudo mkdir -p "$burpsuite_directory"
    status=$?
    check_error_code $status "sudo mkdir -p $burpsuite_directory"

    # update the new directory's permissions
    sudo chmod 777 $burpsuite_directory
    status=$?
    check_error_code $status "sudo chmod 777 $burpsuite_directory"
else
    echo "The directory $burpsuite_directory already exists." | tee -a "$log_file"
fi

# output directory to store burpsuite .sh file
output_path="/home/Kali/tools/burpsuite-pro/burpsuite.sh"

echo -e "\nDownloading and Installing Burpsuite Professional..." | tee -a "$log_file"

if [ ! -e "$output_path" ]; then
    # download the burpsuite.sh file
    echo -e "\nDownloading Burpsuite Professional..." | tee -a "$log_file"
    wget -O $output_path $URL
    status=$?
    check_error_code $status "wget burpsuite.sh"

    # make the burpsuite.sh script executable
    chmod +x $output_path
    status=$?
    check_error_code $status "chmod +x burpsuite.sh"

    # execute the burpsuite.sh script
    echo -e "\nInstalling Burpsuite Professional..." | tee -a "$log_file"
    bash "$output_path" 2> >(tee -a "$log_file" >&2)
    status=$?
    check_error_code $status "bash burpsuite.sh"
else
    echo "The file $output_path already exists." | tee -a "$log_file"
    echo "If you have not installed BurpSuite Professional, navigate to this directory and run the burpsuite.sh file." | tee -a "$log_file"
fi
