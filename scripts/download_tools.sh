#!/bin/bash

# get the current timestamp to use for a unique log filename
timestamp=$(date +"%Y%m%d_%H%M%S")
log_file="/var/log/pkfod-build/tools-logs/download_tools_$timestamp.log"

# function to check error code
# if error code == 0, then append a success message to the log file
# if error code != 0, then append an error message to the log file
check_error_code() {
    command_status=$1
    command_name=$2
    if [ $command_status -eq 0 ]; then
        echo "Command '$command_name' was executed successfully."
        echo "Command '$command_name' was executed successfully." >> "$log_file"
    else
        echo "Command '$command_name' failed with error code $command_status."
        echo "Command '$command_name' failed with error code $command_status." >> "$log_file"
    fi
}

# update package lists in local package database
sudo echo -e "\nRunning sudo apt update..." | tee -a "$log_file"
sudo apt update
status=$?
check_error_code $status "sudo apt update"

# upgrade installed packages by checking for new updates in local package database
echo -e "\nRunning sudo apt upgrade..." | tee -a "$log_file"
sudo apt upgrade -y
status=$?
check_error_code $status "sudo apt upgrade -y"

# install responder
echo -e "\nInstalling responder..." | tee -a "$log_file"
sudo apt install responder
status=$?
check_error_code $status "sudo apt install responder"

# download mitm6 from GitHub
echo -e "\nDownloading mitm6 from GitHub..." | tee -a "$log_file"
mitm6_directory="/home/Kali/tools/mitm6"
if [ ! -d "$mitm6_directory" ]; then
    # clone the repository (and send any errors in stderr to both terminal output and log file)
    git clone https://github.com/dirkjanm/mitm6.git $mitm6_directory 2> >(tee -a "$log_file" >&2)
    status=$?
    check_error_code $status "git clone https://github.com/dirkjanm/mitm6.git $mitm6_directory"
else
    echo "The directory $mitm6_directory already exists." | tee -a "$log_file"
fi

# install impacket
echo -e "\nInstalling impacket..." | tee -a "$log_file"
sudo apt install python3-impacket
status=$?
check_error_code $status "sudo apt install python3-impacket"

# install crackmapexec
echo -e "\nInstalling crackmapexec..." | tee -a "$log_file"
sudo apt install crackmapexec
status=$?
check_error_code $status "sudo apt install crackmapexec"

# download goddi from GitHub
echo -e "\nDownloading goddi from GitHub..." | tee -a "$log_file"
goddi_directory="/home/Kali/tools/goddi"
if [ ! -d "$goddi_directory" ]; then
    # clone the repository (and send any errors in stderr to both terminal output and log file)
    git clone https://github.com/NetSPI/goddi.git $goddi_directory 2> >(tee -a "$log_file" >&2)
    status=$?
    check_error_code $status "git clone https://github.com/NetSPI/goddi.git $goddi_directory"
else
    echo "The directory $goddi_directory already exists." | tee -a "$log_file"
fi

# install VNC
echo -e "\nInstalling VNC..." | tee -a "$log_file"
sudo apt install xtightvncviewer
status=$?
check_error_code $status "sudo apt install xtightvncviewer"

# download o365spray from GitHub
echo -e "\nDownloading o365spray from GitHub..." | tee -a "$log_file"
o365spray_directory="/home/Kali/tools/o365spray"
if [ ! -d "$o365spray_directory" ]; then
    # clone the repository (and send any errors in stderr to both terminal output and log file)
    git clone https://github.com/0xZDH/o365spray.git $o365spray_directory 2> >(tee -a "$log_file" >&2)
    status=$?
    check_error_code $status "git clone https://github.com/0xZDH/o365spray.git $o365spray_directory"
else
    echo "The directory $o365spray_directory already exists." | tee -a "$log_file"
fi

echo -e "\nAll downloads completed!" | tee -a "$log_file"
