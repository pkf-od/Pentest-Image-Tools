#!/bin/bash

# get the current timestamp to use for a unique log filename
timestamp=$(date +"%Y%m%d_%H%M%S")
log_file="/var/log/pkfod-build/nessus-logs/download_nessus_$timestamp.log"

# function to check error code
# if error code == 0, then append a success message to the log file
# if error code != 0, then append an error message to the log file
check_error_code() {
    command_status=$1
    command_name=$2
    if [ $command_status -eq 0 ]; then
        echo "Command '$command_name' was executed successfully."
        echo "Command '$command_name' was executed successfully." >> "$log_file"
    else
        echo "Command '$command_name' failed with error code $command_status."
        echo "Command '$command_name' failed with error code $command_status." >> "$log_file"
    fi
}

echo -e "\nRunning sudo apt update..." | tee -a "$log_file"
sudo apt update
status=$?
check_error_code $status "sudo apt update"

echo -e "\nRunning sudo apt upgrade..." | tee -a "$log_file"
sudo apt upgrade -y
status=$?
check_error_code $status "sudo apt upgrade"

# install CURL if you don't have it
echo -e "\nInstalling CURL..." | tee -a "$log_file"
sudo apt install curl
status=$?
check_error_code $status "sudo apt install curl"

# define the download URL for Nessus
URL="https://www.tenable.com/downloads/api/v2/pages/nessus/files/Nessus-10.5.4-ubuntu1404_amd64.deb"

# define the output directory
nessus_directory="/home/kali/tools/nessus"

echo -e "\nCreating directory to store the download..." | tee -a "$log_file"

# check if the directory exists
if [ ! -d "$nessus_directory" ]; then
    # create the new directory
    sudo mkdir -p "$nessus_directory"
    status=$?
    check_error_code $status "sudo mkdir -p $nessus_directory"

    # change the new directory's permissions
    sudo chmod 777 $nessus_directory
    status=$?
    check_error_code $status "sudo chmod 777 $nessus_directory"
else
    echo "The directory $nessus_directory already exists." | tee -a "$log_file"
fi

# define the expected output path of the file to download
output_path="/home/kali/tools/nessus/Nessus-10.5.3-ubuntu1404_amd64.deb"

echo -e "\nDownloading and Installing Nessus packages..." | tee -a "$log_file"

# check if the file was downloaded
if [ ! -e "$output_path" ]; then
    # download the nessus package to the new directory using CURL
    echo -e "\nDownloading Nessus..." | tee -a "$log_file"
    curl -O $URL --output-dir $nessus_directory
    status=$?
    check_error_code $status "curl -O $URL --output-dir $nessus_directory"

    # install the package
    echo -e "\nInstalling Nessus..." | tee -a "$log_file"
    sudo dpkg -i $output_path
    status=$?
    check_error_code $status "sudo dpkg -i $output_path"
else
    echo "Nessus has already been downloaded and installed." | tee -a "$log_file"
fi

# restart the nessusd daemon
echo -e "\nRestarting nessusd daemon..." | tee -a "$log_file"
sudo systemctl start nessusd
status=$?
check_error_code $status "sudo systemctl start nessusd"

# open nessus in firefox
echo -e "\nOpening Nessus in Firefox..." | tee -a "$log_file"
firefox https://localhost:8834
status=$?
check_error_code $status "firefox https://localhost:8834"
