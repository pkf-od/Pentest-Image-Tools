#!/bin/bash

# get the current timestamp to use for a unique log filename
timestamp=$(date +"%Y%m%d_%H%M%S")
log_file="/var/log/pkfod-build/teamviewer-logs/download_teamviewer_$timestamp.log"

# function to check error code
# if error code == 0, then append a success message to the log file
# if error code != 0, then append an error message to the log file
check_error_code() {
    command_status=$1
    command_name=$2
    if [ $command_status -eq 0 ]; then
        echo "Command '$command_name' was executed successfully."
        echo "Command '$command_name' was executed successfully." >> "$log_file"
    else
        echo "Command '$command_name' failed with error code $command_status."
        echo "Command '$command_name' failed with error code $command_status." >> "$log_file"
    fi
}

echo -e "\nRunning sudo apt update..." | tee -a "$log_file"
sudo apt update
status=$?
check_error_code $status "sudo apt update"

echo -e "\nRunning sudo apt upgrade..." | tee -a "$log_file"
sudo apt upgrade -y
status=$?
check_error_code $status "sudo apt upgrade"

# install wget if you don't have it
echo -e "\nInstalling wget..." | tee -a "$log_file"
sudo apt install wget
status=$?
check_error_code $status "sudo apt install wget"

# define the download URL for the teamviewer download
URL="https://download.teamviewer.com/download/linux/teamviewer-host_amd64.deb?utm_source=google&utm_medium=cpc&utm_campaign=us%7Cb%7Cpr%7C22%7Caug%7Ctv-core-download-sn%7Cnew%7Ct0%7C0&utm_content=Download&utm_term=teamviewer+download"

echo -e "\nCreating directory to store the download..." | tee -a "$log_file"
teamviewer_directory="/home/kali/tools/teamviewer"

# check if the directory exists
if [ ! -d "$teamviewer_directory" ]; then
    # create the new directory
    sudo mkdir -p "$teamviewer_directory"
    status=$?
    check_error_code $status "sudo mkdir -p $teamviewer_directory"

    # update the new directory's permissions
    sudo chmod 777 $teamviewer_directory
    status=$?
    check_error_code $status "sudo chmod 777 $teamviewer_directory"
else
    echo "The directory $teamviewer_directory already exists." | tee -a "$log_file"
fi

# output path to store the teamviewer file
output_path="/home/kali/tools/teamviewer/teamviewer-host_15.43.7_amd64.deb"

echo -e "\nDownloading and Installing TeamViewer packages..." | tee -a "$log_file"

# check if the file exists
if [ ! -e "$output_path" ]; then
    # download the teamviewer package to the new directory using wget
    echo -e "\nDownloading TeamViewer..." | tee -a "$log_file"
    wget -O $output_path $URL
    status=$?
    check_error_code $status "wget -O $output_path $URL"

    # install the package
    echo -e "\nInstalling TeamViewer..." | tee -a "$log_file"
    sudo dpkg -i $output_path
    status=$?
    check_error_code $status "sudo dpkg -i $output_path"
else
    echo "TeamViewer has already been downloaded and installed." | tee -a "$log_file"
fi
